yaml

name: QQé‚®ç®±é€šçŸ¥é…ç½®

# è§¦å‘æ¡ä»¶ï¼šå¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´
on:
  # æ¨é€ä»£ç æ—¶è§¦å‘
  push:
    branches: [main, master]
  
  # æ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºæµ‹è¯•ï¼‰
  workflow_dispatch:
  
  # PRåˆå¹¶æ—¶è§¦å‘
  pull_request:
    types: [closed]
    branches: [main]

# ç¯å¢ƒå˜é‡é…ç½®
env:
  SMTP_SERVER: ${{ secrets.SMTP_HOST }}
  SMTP_PORT: ${{ secrets.SMTP_PORT }}
  SMTP_USER: ${{ secrets.SMTP_USERNAME }}
  SMTP_PASS: ${{ secrets.SMTP_PASSWORD }}
  TO_EMAILS: ${{ secrets.EMAIL_RECIPIENTS }}

jobs:
  send-email:
    runs-on: ubuntu-latest
    
    steps:
      # æ­¥éª¤1ï¼šæ£€æŸ¥ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        
      # æ­¥éª¤2ï¼šæµ‹è¯•QQé‚®ç®±è¿æ¥
      - name: Test QQ Mail Connection
        run: |
          echo "æ­£åœ¨æµ‹è¯•QQé‚®ç®±SMTPè¿æ¥..."
          echo "æœåŠ¡å™¨: $SMTP_SERVER"
          echo "ç«¯å£: $SMTP_PORT"
          echo "ç”¨æˆ·å: $SMTP_USER"
          echo "æˆæƒç : ${SMTP_PASS:0:4}****"  # åªæ˜¾ç¤ºå‰4ä½ï¼Œä¿æŠ¤éšç§
          
      # æ­¥éª¤3ï¼šä½¿ç”¨ä¸“ä¸šçš„é‚®ä»¶å‘é€Action
      - name: Send QQ Mail Notification
        uses: dawidd6/action-send-mail@v3
        with:
          # QQé‚®ç®±æœåŠ¡å™¨é…ç½®
          server_address: smtp.qq.com
          server_port: 465
          secure: true  # QQé‚®ç®±å¿…é¡»ä½¿ç”¨SSL
          
          # è®¤è¯ä¿¡æ¯ï¼ˆä»Secretsè¯»å–ï¼‰
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          
          # é‚®ä»¶å†…å®¹
          subject: "ã€GitHubé€šçŸ¥ã€‘ä»“åº“ ${{ github.repository }} æœ‰æ›´æ–°"
          
          # HTMLæ ¼å¼é‚®ä»¶ï¼ˆæ›´ç¾è§‚ï¼‰
          html_body: |
            <!DOCTYPE html>
            <html>
            <head>
              <meta charset="utf-8">
              <style>
                body {
                  font-family: 'Microsoft YaHei', Arial, sans-serif;
                  line-height: 1.6;
                  color: #333;
                  max-width: 600px;
                  margin: 0 auto;
                  padding: 20px;
                  background-color: #f5f5f5;
                }
                .header {
                  background: linear-gradient(135deg, #12c2e9, #c471ed);
                  color: white;
                  padding: 25px;
                  border-radius: 10px 10px 0 0;
                  text-align: center;
                }
                .content {
                  background: white;
                  padding: 30px;
                  border-radius: 0 0 10px 10px;
                  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                }
                .event-badge {
                  display: inline-block;
                  padding: 5px 12px;
                  background: #4CAF50;
                  color: white;
                  border-radius: 20px;
                  font-size: 14px;
                  margin-bottom: 15px;
                }
                .info-grid {
                  display: grid;
                  grid-template-columns: 100px 1fr;
                  gap: 10px;
                  margin: 20px 0;
                }
                .info-label {
                  font-weight: bold;
                  color: #666;
                }
                .commit-box {
                  background: #f8f9fa;
                  border-left: 4px solid #3498db;
                  padding: 15px;
                  margin: 15px 0;
                  border-radius: 4px;
                }
                .btn {
                  display: inline-block;
                  background: #3498db;
                  color: white;
                  padding: 12px 25px;
                  text-decoration: none;
                  border-radius: 5px;
                  margin-top: 20px;
                  font-weight: bold;
                }
                .footer {
                  margin-top: 30px;
                  padding-top: 20px;
                  border-top: 1px solid #eee;
                  font-size: 12px;
                  color: #999;
                  text-align: center;
                }
              </style>
            </head>
            <body>
              <div class="header">
                <h1>ğŸš€ GitHub äº‹ä»¶é€šçŸ¥</h1>
                <p>æ‚¨çš„ä»£ç ä»“åº“æœ‰æ–°çš„åŠ¨æ€</p>
              </div>
              
              <div class="content">
                <span class="event-badge">
                  ${{ github.event_name == 'push' && 'ä»£ç æ¨é€' || 
                      github.event_name == 'pull_request' && 'PRæ›´æ–°' ||
                      'ä»“åº“äº‹ä»¶' }}
                </span>
                
                <h2>${{ github.repository }}</h2>
                
                <div class="info-grid">
                  <div class="info-label">ğŸ“… æ—¶é—´ï¼š</div>
                  <div>$(date '+%Y-%m-%d %H:%M:%S')</div>
                  
                  <div class="info-label">ğŸ‘¤ æ“ä½œè€…ï¼š</div>
                  <div>${{ github.actor }}</div>
                  
                  <div class="info-label">ğŸŒ¿ åˆ†æ”¯ï¼š</div>
                  <div>${{ github.ref_name }}</div>
                  
                  ${{ github.event.head_commit && '
                  <div class="info-label">ğŸ“ æäº¤IDï¼š</div>
                  <div>' + github.event.head_commit.id.substring(0, 7) + '</div>
                  ' || '' }}
                </div>
                
                ${{ github.event.head_commit && '
                <div class="commit-box">
                  <strong>æäº¤ä¿¡æ¯ï¼š</strong><br>
                  ' + github.event.head_commit.message + '
                  ' + (github.event.head_commit.author && '
                  <div style="margin-top: 10px; color: #666;">
                    æäº¤è€…ï¼š' + github.event.head_commit.author.name + '
                    <' + github.event.head_commit.author.email + '>
                  </div>
                  ' || '') + '
                </div>
                ' || '' }}
                
                ${{ github.event.pull_request && '
                <div class="commit-box">
                  <strong>PRä¿¡æ¯ï¼š</strong><br>
                  æ ‡é¢˜ï¼š' + github.event.pull_request.title + '<br>
                  ç¼–å·ï¼š#' + github.event.pull_request.number + '<br>
                  çŠ¶æ€ï¼š' + github.event.action + '
                </div>
                ' || '' }}
                
                <a href="https://github.com/${{ github.repository }}" class="btn">
                  ğŸ”— å‰å¾€ä»“åº“æŸ¥çœ‹
                </a>
                
                <div class="footer">
                  <p>æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€<br>
                  è¯·ä¸è¦ç›´æ¥å›å¤æ­¤é‚®ä»¶</p>
                  <p>å¦‚éœ€ç®¡ç†é€šçŸ¥è®¾ç½®ï¼Œè¯·è®¿é—®ä»“åº“çš„ GitHub Actions é…ç½®</p>
                </div>
              </div>
            </body>
            </html>
          
          # çº¯æ–‡æœ¬å¤‡ç”¨ç‰ˆæœ¬
          body: |
            å°Šæ•¬çš„ç”¨æˆ·ï¼š
            
            æ‚¨çš„ GitHub ä»“åº“ [${{ github.repository }}] æœ‰æ–°çš„åŠ¨æ€ã€‚
            
            ğŸ“‹ äº‹ä»¶è¯¦æƒ…ï¼š
            -------------------------
            äº‹ä»¶ç±»å‹ï¼š${{ github.event_name }}
            ä»“åº“åç§°ï¼š${{ github.repository }}
            åˆ†æ”¯ï¼š${{ github.ref_name }}
            æ“ä½œè€…ï¼š${{ github.actor }}
            æ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S')
            
            ${{ github.event.head_commit && 'æäº¤ä¿¡æ¯ï¼š' + github.event.head_commit.message || '' }}
            ${{ github.event.pull_request && 'PRä¿¡æ¯ï¼š' + github.event.pull_request.title || '' }}
            
            ğŸ”— æŸ¥çœ‹é“¾æ¥ï¼š
            https://github.com/${{ github.repository }}
            
            -------------------------
            æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€
          
          # å‘ä»¶äººå’Œæ”¶ä»¶äººè®¾ç½®
          from: GitHubé€šçŸ¥æœºå™¨äºº <466875219@qq.com>
          to: ${{ secrets.EMAIL_RECIPIENTS }}
          
          # å…¶ä»–é…ç½®
          attachments: README.md  # å¯é€‰ï¼šé™„ä»¶
          
      # æ­¥éª¤4ï¼šå‘é€æˆåŠŸç¡®è®¤
      - name: Send Success Confirmation
        if: success()
        run: |
          echo "âœ… QQé‚®ç®±é€šçŸ¥å‘é€æˆåŠŸï¼"
          echo "æ”¶ä»¶äºº: ${{ secrets.EMAIL_RECIPIENTS }}"
          echo "å‘é€æ—¶é—´: $(date)"
